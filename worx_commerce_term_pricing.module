<?php

/**
 * Implements hook_menu().
 */
function worx_commerce_term_pricing_menu() {
  $items = array();

  $items['admin/commerce/term_pricing'] = array(
    'title' => 'Term Pricing Settings',
    'description' => 'Review and add new term pricing',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('worx_commerce_term_pricing_settings_form'),
    'access arguments' => array('worx_commerce_term_pricing_admin'),
    'file' => 'worx_commerce_term_pricing.admin.inc',
    'file path' => drupal_get_path('module', 'worx_commerce_term_pricing'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/commerce/term_pricing/view'] = array(
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/commerce/term_pricing/%/delete'] = array(
    'title' => 'Delete Term Pricing Rule',
    'description' => 'Callback to delete a term pricing rule',
    'page callback' => 'worx_commerce_term_pricing_delete_rule',
    'page arguments' => array(3),
    'access arguments' => array('worx_commerce_term_pricing_admin'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function worx_commerce_term_pricing_permission() {
  $return = array();

  $return['worx_commerce_term_pricing_admin'] = array(
    'title' => t('Administer Term Pricing'),
    'description' => t('Allows the user to apply price changing term rules'),
  );

  return $return;
}

/**
 * Implements hook_action_info().
 */
function worx_commerce_term_pricing_rules_action_info() {
  $rules = array();

  $rules['worx_commerce_term_pricing_calculate_price'] = array(
    'label' => t('Calculate A Term Price Product\'s Price'),
    'group' => t('Worx Commerce Term Pricing'),
    'parameter' => array(
      'product' => array(
        'label' => t('Commerce Line Item'),
        'type' => 'commerce_line_item',
        'description' => t('The Commerce Line Item used to calculate price.')
      ),
    ),
    'provides' => array(
      'calculated_price' => array(
        'label' => t('Calculated Price'),
        'type' => 'decimal',
      ),
    ),
  );

  return $rules;
}

/**
 * @param $line_item
 *  Commerce Line Item Object
 * @return float
 */
function worx_commerce_term_pricing_calculate_price($line_item) {
  $product = commerce_product_load_by_sku($line_item->line_item_label);
  $base_price = $product->commerce_price[LANGUAGE_NONE][0]['amount'];
  // If the product in question has not been added to a cart, bail out.
  if (!isset($line_item->line_item_id)) {
    return array(
      'calculated_price' => $base_price,
    );
  }
  $flavor = $line_item->field_bulk_flavor[LANGUAGE_NONE][0]['tid'];
  // @TODO: We won't be using these rules to begin with, but may enable them
  // later.
  //$pgvg = $line_item->field_bulk_pg_vg[LANGUAGE_NONE][0]['tid'];
  //$strength = $line_item->field_bulk_strength[LANGUAGE_NONE][0]['tid'];

  // First we see if a rule matches both the flavor & SKU
  $query = db_select('commerce_term_pricing_rules', 'ctpr')
    ->fields('ctpr')
    ->condition('product_sku', $line_item->line_item_label)
    ->condition('flavor_tid', $flavor)
    ->execute()
    ->fetchAssoc();

  // If we have not found a rule which applies to both flavor and sku, check for
  // one which applies just to the flavor.
  if (!is_array($query)) {
    $query = db_select('commerce_term_pricing_rules', 'ctpr')
      ->fields('ctpr')
      ->condition('flavor_tid', $flavor)
      ->execute()
      ->fetchAssoc();
  }
  // Check one to see if we got a rule, if not just return the product's base
  // price.
  if (!is_array($query)) {
    return array(
      'calculated_price' => $base_price,
    );
  }

  // Assuming we found a rule which applies to this product, calculate the new
  // price and return it.
  $change = $query['price_change'];
  $type = $query['change_type'];

  // If the change is a flat change, simple add the two values together
  // after converting the change to minor units. Otherwise determine % value
  // and multiply by the change value, rounding to account for decimal %s.
  if ($type == 'flat') {
    $change = (int) ($change * 100); // convert to minor units, discard any extra decimal places;
    $calculated_price = $base_price + $change;
  }
  else {
    $calculated_price = round($base_price + (($base_price/100) * $change));
  }

  return array(
    'calculated_price' => $calculated_price,
  );
}

function worx_commerce_term_pricing_delete_rule($rule_id) {
  $deleted = db_delete('commerce_term_pricing_rule')
    ->condition('cprid', $rule_id)
    ->execute();

  drupal_set_message('Pricing Rule Deleted');

  drupal_goto(drupal_get_destination());
}
